<script>
    window.productGalleries = false;
</script>

<div id="productGallery" style="width: 100%; position: relative;">
    <style>

        .gkProductGallery {
            width: 100%;
            margin: 0 auto;
            position: relative;
        }

        #gkProductGalleryTemplate {
            display : none;
        }

        .gallery-header {
            text-align: center;
            font-size: 46px;
            line-height: 46px;
            font-family: 'adobe-garamond-pro';
            color: rgba(72, 72, 72, 1);

            margin-bottom: 10px
        }

        .gallery-header p {
            margin: 0;
        }

        .gallery-header-border-bottom {
            width: 90px;
            border-bottom: 1px solid rgba(0,0,0,.15);
            margin-left: auto;
            margin-right: auto;
        }

        .images-and-descriptions-container {
            height: 468px;
            position: relative;
        }

        /*LINKS SECTION*/

        .links {
            text-align: center;
            line-height: 60px;
        }

        .link {
            display: inline-block;
            margin-right: 10px;
            text-transform: uppercase;
            font-size: 14px;
            font-family: "proxima-nova";
            color: rgba(72, 72, 72, 1);
            cursor: pointer;

            -webkit-transition: color 0.5s ease;

                    transition: color 0.5s ease;
        }

        .link:hover {
            color: rgba(72, 72, 72, 0.8);
        }

        .link-bullet {
            display: inline-block;
            height: 60px;
            width: 3px;
            margin-right: 10px;
            vertical-align: bottom;
            background-image: url('https://static1.squarespace.com/static/52d881e0e4b093afad1a2ae2/t/5563a289e4b08b2ebc704d9b/1432593036851/?format=100w&storage=local');
            background-repeat: no-repeat;
            background-position: center;
        }

        .link.active {
            color: rgba(49, 86, 196, 1);
        }

        .link.active:hover {
            color: rgba(49, 86, 196, 0.8)
        }

        /*IMAGES SECTION*/

        .images-container {
            width: 100%;
            height: 353px;
            position: relative;
            overflow: hidden;
        }

        .image {
            position: absolute;
            opacity: 0;
            height: 353px;
            width: 100%;
            -webkit-transition: opacity 0.5s ease;
                    transition: opacity 0.5s ease;

            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
        }

        .image.active {
            opacity: 1;
        }

        /*TRANSPORT CONTROLS SECTION */

        .transport-controls-overlay {
            width: 100%;
            height: 353px;
            position: absolute;
            top: 0;
            left: 0;
        }

        .previous-arrow-container{
            height: 100%;
            line-height: 100%;
            width: 28px;
            position: absolute;
            left: 0;
            top: 0;
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
                -ms-flex-align: center;
                    align-items: center;
            -webkit-transition: background 0.5s;
                    transition: background 0.5s;
        }

        .previous-arrow-container:hover {
            cursor: pointer;
        }
        .previous-arrow-container:hover .previous-arrow {
            background-image: url('https://static1.squarespace.com/static/52d881e0e4b093afad1a2ae2/t/558722aee4b09925a6d2bc97/1434919599433/?format=100w&storage=local');
        }

        .previous-arrow {
            background-image: url('https://static1.squarespace.com/static/52d881e0e4b093afad1a2ae2/t/5563b61ce4b0b7fb308e00b2/1432598045084/?format=100w&storage=local');
            background-repeat: no-repeat;
            width: 14px;
            height: 24px;
            margin-left: 8px;
        }

        .next-arrow-container {
            height: 100%;
            line-height: 100%;
            width: 28px;
            position: absolute;
            right: 0;
            top: 0;
            display: -webkit-box;
            display: -webkit-flex;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-align: center;
            -webkit-align-items: center;
                -ms-flex-align: center;
                    align-items: center;
            -webkit-transition: background 0.5s;
                    transition: background 0.5s;
        }

        .next-arrow-container:hover {
            cursor: pointer;
        }

        .next-arrow-container:hover .next-arrow {
            background-image: url('https://static1.squarespace.com/static/52d881e0e4b093afad1a2ae2/t/558722d0e4b0afbde970b94e/1434919633507/?format=100w&storage=local');
        }

        .next-arrow {
            background-image: url('https://static1.squarespace.com/static/52d881e0e4b093afad1a2ae2/t/5563b588e4b044d8a276d5b6/1432597896873/?format=100w&storage=local');
            background-repeat: no-repeat;
            width: 14px;
            height: 24px;
            margin-left: 8px;
        }

        .circles {
            text-align: center;
            bottom: 12px;
            position: absolute;
            width: 100%;

            -webkit-user-select: none;

               -moz-user-select: none;

                -ms-user-select: none;

                    user-select: none;
        }

        .circle {
            height: 12px;
            width: 12px;
            display: inline-block;
            background-image: url('https://static1.squarespace.com/static/52d881e0e4b093afad1a2ae2/t/5563b6d5e4b0ebbd3eaf24bf/1432598229756/?format=100w&storage=local');
            background-repeat: no-repeat;

            padding-left: 6px;
            cursor: pointer;
        }

        .circle.active {
            background-image: url('https://static1.squarespace.com/static/52d881e0e4b093afad1a2ae2/t/5563b703e4b09a14dbb50a03/1432598276497/?format=100w&storage=local');
        }

        /*MOBILE STYLES*/
        #gkProductGalleryMobile {
            width: 100%;
            margin: 0 auto;
            position: relative;
        }

        #itemTemplate {
            display : none;
        }

        .mobile-gallery-header {
            text-align: center;
            font-size: 46px;
            line-height: 46px;
            font-family: 'adobe-garamond-pro';
            color: rgba(72, 72, 72, 1);

            margin-bottom: 10px
        }

        .mobile-gallery-header-border-bottom {
            width: 90px;
            border-bottom: 1px solid rgba(0,0,0,.15);
            margin-left: auto;
            margin-right: auto;

            margin-bottom: 40px;
        }

        .mobile-item {
            margin-bottom: 40px;
        }

        .mobile-item-header {
            font-family: 'adobe-garamond-pro';
            text-align: center;
            font-size: 34px;
            line-height: 34px;
            color: rgba(72, 72, 72, 1);
            margin-bottom: 10px;
        }
        .mobile-item-image {

        }
        .mobile-item-description {
            text-align: left;
            font-size: 19px;
            line-height: 19px;
            color: rgba(72, 72, 72, 1);
        }

        /*SUBTITLE AND DESCRIPTION SECTION*/

        .subtitle-description-container {
            height: 115px;
            line-height: 115px;

            width: 100%;

            display: -webkit-box;

            display: -webkit-flex;

            display: -ms-flexbox;

            display: flex;
            -webkit-box-pack: start;
            -webkit-justify-content: flex-start;
                -ms-flex-pack: start;
                    justify-content: flex-start;
            -webkit-box-orient: horizontal;
            -webkit-box-direction: normal;
            -webkit-flex-direction: row;
                -ms-flex-direction: row;
                    flex-direction: row;
            -webkit-box-align: center;
            -webkit-align-items: center;
                -ms-flex-align: center;
                    align-items: center;
        }

        .subtitle {
            width: 30%;
            font-family: 'adobe-garamond-pro';

            font-size: 34px;
            line-height: 34px;
            color: rgba(72, 72, 72, 1);
        }

        .description {
            width: 70%;
            text-align: left;
            font-size: 19px;
            line-height: 19px;
            color: rgba(72, 72, 72, 1);
        }

        /*LOADING OVERLAY*/
        .loading-overlay {
            position: absolute;
            display : inline-block;
            height: 100%;
            width: 100%;
            z-index: 1;
            top: 0;
            background-color: #F0F0F0;
        }

        .height-zero {
            height: 0;
        }

        /*BREAKPOINTS*/

        @media only screen and (max-width: 3000px) {
            /* place CSS for desktop */

            #gkProductGalleryMobile {
                display: none;
            }

            .gkProductGallery {
                min-height: 586px;
            }
        }

        @media only screen and (max-width: 1000px) {
            /* place CSS for smaller screens */

            .gkProductGallery {
                min-height: 647px;
            }
        }

        @media only screen and (max-width: 700px) {
            /* place CSS for mobile */

            #gkProductGalleryMobile {
                display: block;
            }

            #gkProductGalleryDesktop {
                display: none;
            }
        }

    </style>

    <div id="gkProductGalleryTemplate">
        <div id="gkProductGalleryDesktop">
            <div class="gallery-header"></div>
            <div class="gallery-header-border-bottom"></div>
            <div class="links">
                <div id="bulletTemplate" class="link-bullet"></div>
                <div id="linkTemplate" class="" img-selector="" subtitle="" description=""></div>
            </div>

            <div class="images-and-descriptions-container">
                <div class="images-container">
                    <div id="imageTemplate" class=""></div>
                </div>
                <div class="transport-controls-overlay">
                    <div class="previous-arrow-container">
                        <div class="previous-arrow"></div>
                    </div>
                    <div class="next-arrow-container">
                        <div class="next-arrow"></div>
                    </div>

                    <div class="circles">
                        <div id="circleTemplate" class="circle"></div>
                    </div>
                </div>
                <div class="subtitle-description-container">
                    <div class="subtitle"></div>
                    <div class="description"></div>
                </div>
            </div>
        </div>

        <div id="gkProductGalleryMobile">
            <div class="mobile-gallery-header"></div>
            <div class="mobile-gallery-header-border-bottom"></div>

            <div id="itemsContainer"></div>

            <div id="itemTemplate">
                <div class="mobile-item-header"></div>
                <div class="mobile-item-image">
                    <img>
                </div>
                <div class="mobile-item-description"></div>
            </div>
        </div>
    </div>

    <div class="loading-overlay"></div>

    <script type="text/javascript">
        (function(globals) {
            //////////////////////////////////////////////////////////////////
            var productGalleries = globals.productGalleries || ['/product-galleries/mb-fusion-800-design', '/product-galleries/mb-fusion-800-technology'];

            productGalleries = productGalleries.map(function(productGalleryUrl, index) {
                    return {
                        url : productGalleryUrl,
                        index : index,
                        header : null,
                        products : null,
                        $container : null
                    };
                });

            //////////////////////////////////////////////////////////////////
            YUI().use('io', 'promise', 'anim', function (Y) {
                var galleryBuilder = {
                    start : start,
                    getProductJson : getProductJson,
                    createDomStructure : createDomStructure,
                    addEventListeners : addEventListeners
                };

                function start() {
                    console.log('start');

                    showLoadingOverlay();

                    var galleryTemplate = document.querySelector('#gkProductGalleryTemplate');

                    Y.Promise.all(productGalleries.map(function(thisGallery) {
                        return galleryBuilder.getProductJson(thisGallery.url)
                            .then(function(serverResponse) {
                                thisGallery.products = deserializeServerResponseProducts(serverResponse);
                                thisGallery.header = deserializeServerResponseHeader(serverResponse);


                                thisGallery.$container = galleryTemplate.cloneNode(true);
                                thisGallery.$container.id = '';
                                thisGallery.$container.classList.add('gkProductGallery');

                                if(thisGallery.index === 0) {
                                    document.querySelector('#productGallery').insertBefore(thisGallery.$container, document.querySelector('#productGallery').firstChild);
                                } else {
                                    document.querySelector('#productGallery').appendChild(thisGallery.$container);
                                }

                                galleryBuilder.createDomStructure(thisGallery);
                                galleryBuilder.addEventListeners(thisGallery);
                            });
                    }))
                    .then(function() {
                        galleryTemplate.parentElement.removeChild(galleryTemplate);
                        hideLoadingOverlay();
                    })
                    .catch(function() {
                        window.console.log('everything failed, remove myself from the dom.');
                        document.querySelector('#productGallery').parentElement.removeChild(document.querySelector('#productGallery'));
                    });
                }

                function getProductJson(thisGalleriesUrl) {
                    return new Y.Promise(function (resolve, reject) {
                        Y.io(thisGalleriesUrl + '?format=json-pretty', {
                            on: {
                                start : function() {},
                                success: function(transactionId, repsonseObj) {
                                    resolve(JSON.parse(repsonseObj.response));
                                },
                                complete : function() {},
                                failure : reject,
                                end : function() {}
                            }
                        });
                    });
                }

                function deserializeServerResponseProducts(serverResponse) {
                    return serverResponse.items.map(function(item, index) {
                        return {
                            id : index,
                            linkText : item.title,
                            imageUrl : item.assetUrl,
                            subtitleText : item.title,
                            description : item.body,
                            isActive : false
                        };
                    });
                }

                function deserializeServerResponseHeader(serverResponse) {
                    return serverResponse.collection.description;
                }

                function createDomStructure(thisGallery) {
                    _createDesktopDomStructure(thisGallery);
                    _createMobileDomStructure(thisGallery);
                }

                function _createDesktopDomStructure(thisGallery) {
                    var $linksArea = thisGallery.$container.querySelector('.links'),
                        $imagesArea = thisGallery.$container.querySelector('.images-container'),
                        $circlesArea = thisGallery.$container.querySelector('.circles'),
                        bulletTemplate = thisGallery.$container.querySelector('#bulletTemplate'),
                        circleTemplate = thisGallery.$container.querySelector('#circleTemplate'),
                        linkTemplate = thisGallery.$container.querySelector('#linkTemplate'),
                        imageTemplate = thisGallery.$container.querySelector('#imageTemplate');

                    thisGallery.products.forEach(function(thisProduct, index) {
                        var linkElement = linkTemplate.cloneNode(true),
                            imageElement = imageTemplate.cloneNode(true),
                            bulletElement = bulletTemplate.cloneNode(true),
                            circleElement = circleTemplate.cloneNode(true);

                        linkElement.classList.add('link');
                        linkElement.setAttribute('img-selector', '#productGalleryImage'+ thisProduct.id);
                        linkElement.setAttribute('subtitle', thisProduct.subtitleText);
                        linkElement.setAttribute('description', thisProduct.description);
                        linkElement.id = 'link-' + thisProduct.id;

                        linkElement.innerHTML = thisProduct.linkText;

                        imageElement.id = 'productGalleryImage'+ thisProduct.id;
                        imageElement.classList.add('image');
                        imageElement.style.backgroundImage = 'url('+ thisProduct.imageUrl +')';

                        circleElement.id = 'circle-' + thisProduct.id;

                        if(index === 0) {
                            imageElement.classList.add('active');
                            linkElement.classList.add('active');
                            circleElement.classList.add('active');

                            thisGallery.$container.querySelector('.subtitle').innerHTML = thisProduct.subtitleText;
                            thisGallery.$container.querySelector('.description').innerHTML = thisProduct.description;

                            thisProduct.isActive = true;
                        } else {
                            bulletElement.id = '';
                            $linksArea.appendChild(bulletElement);
                        }

                        $circlesArea.appendChild(circleElement);
                        $linksArea.appendChild(linkElement);
                        $imagesArea.appendChild(imageElement);
                    });

                    thisGallery.$container.querySelector('.gallery-header').innerHTML = thisGallery.header;

                    linkTemplate.parentElement.removeChild(linkTemplate);
                    imageTemplate.parentElement.removeChild(imageTemplate);
                    bulletTemplate.parentElement.removeChild(bulletTemplate);
                    circleTemplate.parentElement.removeChild(circleTemplate);
                }

                function _createMobileDomStructure(thisGallery) {
                    var itemsContainer = thisGallery.$container.querySelector('#gkProductGalleryMobile').querySelector('#itemsContainer'),
                        itemTemplate = thisGallery.$container.querySelector('#gkProductGalleryMobile').querySelector('#itemTemplate');

                    thisGallery.products.forEach(function(thisProduct, index) {
                        var itemElement = itemTemplate.cloneNode(true);

                        itemElement.classList.add('mobile-item');

                        itemElement.querySelector('.mobile-item-header').innerHTML = thisProduct.subtitleText;
                        itemElement.querySelector('.mobile-item-image img').src = thisProduct.imageUrl;
                        itemElement.querySelector('.mobile-item-description').innerHTML = thisProduct.description;

                        itemElement.id = '';

                        itemsContainer.appendChild(itemElement);
                    });

                    thisGallery.$container.querySelector('#gkProductGalleryMobile').querySelector('.mobile-gallery-header').innerHTML = thisGallery.header;

                    itemTemplate.parentElement.removeChild(itemTemplate);
                }

                function addEventListeners(thisGallery) {
                    var subtitleNode = thisGallery.$container.querySelector('.subtitle'),
                        descriptionNode = thisGallery.$container.querySelector('.description'),
                        linkNodes = thisGallery.$container.querySelectorAll('.link'),
                        imageNodes = thisGallery.$container.querySelectorAll('.image'),
                        circleNodes = thisGallery.$container.querySelectorAll('.circle'),
                        arrowLeftNode = thisGallery.$container.querySelector('.previous-arrow-container'),
                        arrowRightNode = thisGallery.$container.querySelector('.next-arrow-container');

                    [].forEach.call(linkNodes, function(linkNode) {
                        linkNode.addEventListener('click', function() {
                            setProductActive(thisGallery, linkNode.id.split('-')[1]);
                        });
                    });

                    [].forEach.call(circleNodes, function(circleNode) {
                        circleNode.addEventListener('click', function() {
                            setProductActive(thisGallery, circleNode.id.split('-')[1]);
                        });
                    });

                    arrowLeftNode.addEventListener('click', goToPreviousProduct.bind(null, thisGallery));

                    arrowRightNode.addEventListener('click', goToNextProduct.bind(null, thisGallery));
                }

                function setProductActive(thisGallery, productId) {
                    var subtitleNode = thisGallery.$container.querySelector('.subtitle'),
                        descriptionNode = thisGallery.$container.querySelector('.description'),
                        linkNodes = thisGallery.$container.querySelectorAll('.link'),
                        imageNodes = thisGallery.$container.querySelectorAll('.image'),
                        circleNodes = thisGallery.$container.querySelectorAll('.circle'),
                        thisProductElement = thisGallery.$container.querySelector('#link-'+ productId),
                        thisProductsCircleElement = thisGallery.$container.querySelector('#circle-'+ productId),

                        imageSelector = thisProductElement.getAttribute('img-selector'),
                        subtitle = thisProductElement.getAttribute('subtitle'),
                        description = thisProductElement.getAttribute('description');

                    [].forEach.call(linkNodes, function(linkNode) {
                        linkNode.classList.remove('active');
                    });

                    [].forEach.call(imageNodes, function(imageNode) {
                        imageNode.classList.remove('active');
                    });

                    [].forEach.call(circleNodes, function(circleNode) {
                        circleNode.classList.remove('active');
                    });

                    thisProductsCircleElement.classList.add('active');

                    thisProductElement.classList.add('active');

                    thisGallery.$container.querySelector(imageSelector)
                        .classList.add('active');

                    subtitleNode.innerText = subtitle;
                    descriptionNode.innerHTML = description;

                    thisGallery.products.forEach(function(thisProduct) {
                        thisProduct.isActive = false;
                        if(thisProduct.id.toString() === productId.toString()) {
                            thisProduct.isActive = true;
                        }
                    });
                }

                function goToPreviousProduct(thisGallery) {
                    var productIdToMakeActive;

                    thisGallery.products.forEach(function(thisProduct, index) {
                        if(thisProduct.isActive) {
                            if(thisProduct.id === 0) { // Its the first one, so go to the last one.
                                productIdToMakeActive = thisGallery.products[thisGallery.products.length - 1].id;
                            } else {
                                productIdToMakeActive = thisGallery.products[index - 1].id;
                            }
                        }
                    });

                    setTimeout(function() { setProductActive(thisGallery, productIdToMakeActive); }, 0);
                }

                function goToNextProduct(thisGallery) {
                    var productIdToMakeActive;

                    thisGallery.products.forEach(function(thisProduct, index) {
                        if(thisProduct.isActive) {
                            if(thisProduct.id === (thisGallery.products.length - 1)) { // Its the last one, so go to the first one.
                                productIdToMakeActive = thisGallery.products[0].id;
                            } else {
                                productIdToMakeActive = thisGallery.products[thisProduct.id + 1].id;
                            }
                        }
                    });

                    setTimeout(function() { setProductActive(thisGallery, productIdToMakeActive); }, 0);
                }

                function showLoadingOverlay() {
                    // is shown by default;
                }

                function hideLoadingOverlay() {
                    var animation = new Y.Anim({
                        node: '.loading-overlay',
                        to: {
                            opacity: 0,
                            display: 'none'
                        }
                    });

                    animation.run();

                    animation.on('end', function() {
                        animation.get('node').addClass('height-zero');
                    });
                }

                document.addEventListener('DOMContentLoaded', function() {
                    galleryBuilder.start();
                });
            });

        })(window);
    </script>
</div>
